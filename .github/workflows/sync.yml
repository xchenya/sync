name: Sync Upstream Releases

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      repositories:
        description: 'è¦åŒæ­¥çš„ä»“åº“åˆ—è¡¨ (æ ¼å¼: owner/repo, å¤šä¸ªç”¨é€—å·åˆ†éš”)'
        required: true
        default: 'AlistGo/alist,Xmarmalade/alisthelper'

jobs:
  sync-releases:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      GH_TOKEN: ${{ github.token }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git jq zip
          sudo apt-get install -y gh || true

      - name: Determine repositories
        id: set-repos
        run: |
          if [ -n "${{ github.event.inputs.repositories }}" ]; then
            REPOS="${{ github.event.inputs.repositories }}"
          elif [ -n "${{ vars.UPSTREAM_REPOSITORIES }}" ]; then
            REPOS="${{ vars.UPSTREAM_REPOSITORIES }}"
          else
            REPOS="AlistGo/alist"
          fi
          echo "REPOSITORIES=${REPOS}" >> $GITHUB_OUTPUT

      - name: Process repositories
        run: |
          set -euo pipefail
          mkdir -p sync-history
          history_file="sync-history/history.json"
          [ -f "$history_file" ] || echo "{}" > "$history_file"

          mapfile -t repos <<< <(echo "${{ steps.set-repos.outputs.REPOSITORIES }}" | tr ',' '\n')

          for upstream in "${repos[@]}"; do
            echo "ğŸ” æ­£åœ¨å¤„ç†: $upstream"
            owner=$(cut -d/ -f1 <<< "$upstream")
            repo_name=$(cut -d/ -f2 <<< "$upstream")

            # è·å–æœ€æ–°æ­£å¼ Release tagï¼Œå¦‚æœæ²¡æœ‰åˆ™è·å– Tag
            tag=$(gh api repos/$upstream/releases --jq '[.[] | select(.prerelease == false)][0].tag_name' || echo "")
            if [[ -z "$tag" || "$tag" == "null" ]]; then
              echo "âš ï¸ æœªæ‰¾åˆ°æ­£å¼ Releaseï¼Œå°è¯•è·å– Tag"
              tag=$(gh api repos/$upstream/tags --jq '.[0].name' || echo "")
            fi
            if [[ -z "$tag" || "$tag" == "null" ]]; then
              echo "âŒ $upstream æ— æ³•è·å– tagï¼Œè·³è¿‡"
              continue
            fi

            # æ¯”å¯¹å†å²è®°å½•
            last_tag=$(jq -r --arg repo "$upstream" '.[$repo] // empty' "$history_file")
            if [[ "$last_tag" == "$tag" ]]; then
              echo "â­ï¸ $upstream çš„ tag [$tag] å·²åŒæ­¥ï¼Œè·³è¿‡"
              continue
            fi

            # ä¸‹è½½æºç  zip
            zip_name="${repo_name}-${tag}.zip"
            zip_url="https://github.com/${upstream}/archive/refs/tags/${tag}.zip"

            echo "â¬‡ï¸ ä¸‹è½½: $zip_url"
            if ! wget -q -O "$zip_name" "$zip_url"; then
              echo "âš ï¸ ä¸‹è½½å¤±è´¥ï¼Œä½¿ç”¨ git å…‹éš†ç”Ÿæˆ zip"
              git clone --depth 1 --branch "$tag" "https://github.com/$upstream.git" "${repo_name}-${tag}-src"
              pushd "${repo_name}-${tag}-src" >/dev/null
              zip -qr "../$zip_name" .
              popd >/dev/null
              rm -rf "${repo_name}-${tag}-src"
            fi

            md5sum=$(md5sum "$zip_name" | awk '{print $1}')
            timestamp=$(date -u +'%Y-%m-%d-%H%M')
            sync_tag="release-${timestamp}"

            echo "ğŸš€ åˆ›å»º Release: $sync_tag"
            gh release create "$sync_tag" "$zip_name" \
              --title "$timestamp: ${repo_name} (${tag})" \
              --notes "MD5: $md5sum\nRepo: $upstream\nSource Tag: $tag"

            echo "âœ… åŒæ­¥å®Œæˆ: $upstream @ $tag"

            # æ›´æ–°è®°å½•
            tmp_file=$(mktemp)
            jq --arg repo "$upstream" --arg tag "$tag" '.[$repo] = $tag' "$history_file" > "$tmp_file"
            mv "$tmp_file" "$history_file"
            rm -f "$zip_name"
          done

      - name: Commit sync history
        run: |
          if [[ -n "$(git status --porcelain sync-history)" ]]; then
            git config user.name "GitHub Actions"
            git config user.email "actions@github.com"
            git add sync-history
            git commit -m "Update sync history records"
            git push
            echo "ğŸ“¤ åŒæ­¥è®°å½•å·²æäº¤"
          else
            echo "âœ… æ²¡æœ‰å˜åŒ–ï¼Œæ— éœ€æäº¤"
          fi
